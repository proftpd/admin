#!/usr/bin/python -tt

# ProFTPD Mirror Network Maintenance System
# Copyright (c) 2010, John Morrissey <jwm@horde.net>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307, USA.

import cgi
import optparse
import sys

import MySQLdb
import MySQLdb.cursors

import mmaint_creds

parser = optparse.OptionParser()
parser.add_option('-t', '--type', dest='type', default=None,
	help='type of mirrors to list', metavar='ftp|www')

(options, args) = parser.parse_args()

if len(args) > 0:
	parser.print_help()
	sys.exit(1)

if not options.type or options.type not in ['ftp', 'www']:
    parser.print_help()
    sys.exit(1)


db = MySQLdb.connect(host=mmaint_creds.DB['host'],
	user=mmaint_creds.DB['user'], passwd=mmaint_creds.DB['pass'],
	db=mmaint_creds.DB['db'], cursorclass=MySQLdb.cursors.DictCursor)
c = db.cursor()

print """
<: $html_title = "Downloading and mirror sites" :>//

#include "header.epl"

<!-- This output is autogenerated; do not edit manually. To update, use the
     ProFTPD Mirror Maintenance system. -->

<h1><: print "$html_title" :></h1>
"""

if options.type == 'ftp':
    print """
        <p>Please use the mirror that's closest to you. If you would like to
        volunteer to be a mirror site, please read the
    	<a href="/howtomirror.html">Mirroring HOWTO</a> page.</p>
    """
elif options.type == 'www':
    print """
        <p>This is a list of active mirrors of this website; the home site is
    	<a href="http://www.proftpd.org/">www.proftpd.org</a>. If you wish to
        mirror this site, please read our
    	<a href="/howtomirror.html">Mirroring HOWTO</a> page.</p>

        <p>In addition to the direct links further down this page, a number of
        the web mirror sites have been configured to accept connections to
        www.&lt;countrycode&gt;.proftpd.org. These can be accessed by visiting
        http://www.&lt;isocode&gt;.proftpd.org/.</p>

        <p>The countries which have mirrors are listed below. Please use your
        closest geographic mirror to conserve bandwidth.</p>
    """

print """
    <div style="text-align: center;">
"""

if options.type == 'ftp':
	base_url = 'ftp://ftp';
elif options.type == 'www':
	base_url = 'http://www';

query = """
    SELECT DISTINCT country_iso 
      FROM %smirrors
     WHERE live = 'true'
  ORDER BY country_iso
""" % options.type
c.execute(query)

for row in c.fetchall():
    print """
    	<a href="%s.%s.proftpd.org/">%s</a>
   	""" % (base_url, row['country_iso'], row['country_iso'])

print """
    </div>
    <hr />
"""

query = """
	SELECT site, admin, city, country_iso, countrycode.country, sequence
	  FROM %smirrors LEFT JOIN countrycode ON
           %smirrors.country_iso = countrycode.iso
	 WHERE live = 'true'
""" % (options.type, options.type)
c.execute(query)

for row in c.fetchall():
    info = row.copy()
    if info['city']:
        info['city'] = '(%s)' % cgi.escape(info['city'])
    if info['country']:
        info['country'] = '(%s)' % cgi.escape(info['country'])
    if info['admin']:
        info['admin'] = 'Maintained by: %s<br />' % cgi.escape(info['admin'])
    info.update({
        'base_url': base_url,
    })

    print """
		<p>
			<a href="%(base_url)s%(sequence)s.%(country_iso)s.proftpd.org">%(base_url)s%(sequence)s.%(country_iso)s.proftpd.org/</a>
            <br />
			<a href="%(site)s">%(site)s</a>
			<br />
			Location: %(country)s %(city)s
			<br />
			%(admin)s
		</p>
    """ % info

print """
    #include "footer.epl"
"""
