#!/usr/local/bin/php -q
<?php

/* ProFTPD Mirror Network Maintenance System
 * Copyright (c) 2005, John Morrissey <jwm@horde.net>
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307, USA.
 */

function usage() {
	// FIXME
	$basename = basename('mirrorList.php');
	print <<<EOM
Usage: $basename [option]...
    -t|--type (ftp|www)  Type of mirror list to generate

EOM;
}

require_once 'Console/Getopt.php';
require_once 'DB.php';

$args = Console_Getopt::getopt(Console_Getopt::readPHPArgv(),
	't:', array('type='));
foreach ($args[0] as $arg) {
	switch ($arg[0]) {
	case 't':
	case '--type':
		if ($arg[1] != 'ftp' && $arg[1] != 'www') {
			usage();
			exit;
		}
		$TYPE = $arg[1];
		break;
	default:
		usage();
		exit;
	}
}

if (empty($TYPE)) {
	usage();
	exit;
}

?>

<: $html_title = "Downloading and mirror sites" :>//

#include "header.epl"

<!-- This output is autogenerated, do not edit manually. To update, use the
     ProFTPD Mirror Maintenance system. -->

<h1><: print "$html_title" :></h1>

<?php if ($TYPE == 'ftp'): ?>
    <p>Please use the mirror that's closest to you. If you would like to
    volunteer to be a mirror site, please read the
	<a href="/howtomirror.html">Mirroring HOWTO</a> page.</p>
<?php elseif ($TYPE == 'www'): ?>
    <p>This is a list of active mirrors of this website; the home site is
	<a href="http://www.proftpd.org/">www.proftpd.org</a>. If you wish to
    mirror this site, please read our
	<a href="/howtomirror.html">Mirroring HOWTO</a> page.</p>

    <p>In addition to the direct links further down this page, a number of
    the web mirror sites have been configured to accept connections to
    www.&lt;countrycode&gt;.proftpd.org. These can be accessed by visiting
    http://www.&lt;isocode&gt;.proftpd.org/.</p>

    <p>The countries which have mirrors are listed below. Please use your
    closest geographic mirror to conserve bandwidth.</p>
<?php endif; ?>

<div style="text-align: center;">

<?php
	$db = &DB::connect('mysql://SQL-USER:SQL-PASSWORD@localhost/proftpd');
	if (PEAR::isError($db)) {
		die("Couldn't contact database server: " . $db->getMessage() . "\n");
	}

	if ($TYPE == 'ftp') {
		$table = 'ftpmirrors';
		$baseUrl = 'ftp://ftp';
	} elseif ($TYPE == 'www') {
		$table = 'wwwmirrors';
		$baseUrl = 'http://www';
	}

	$query  = 'SELECT DISTINCT country_iso ';
	$query .= "FROM $table ";
	$query .= 'WHERE live = "true" ';
	$query .= 'ORDER BY country_iso';

	$result = $db->query($query);
	if (PEAR::isError($result)) {
		die("Couldn't query database server: " . $queryResult->getMessage() . "\n");
	}
?>

<?php while (($row = $result->fetchRow(DB_FETCHMODE_ASSOC))): ?>
	<a href="<?php echo $baseUrl ?>.<?php echo $row['country_iso'] ?>.proftpd.org/"><?php echo $row['country_iso'] ?></a>
<?php endwhile; ?>

</div>
<hr />

<?php
	$query  = 'SELECT site, admin, city, country_iso, countrycode.country, ';
	$query .= '       sequence ';
	$query .= "FROM $table LEFT JOIN countrycode ON ";
	$query .= "     $table.country_iso = countrycode.iso ";
	$query .= 'WHERE live = "true"';

	$result = $db->query($query);
	if (PEAR::isError($result)) {
		die("Couldn't query database server: " . $queryResult->getMessage() . "\n");
	}
?>

<?php while (($row = $result->fetchRow(DB_FETCHMODE_ASSOC))): ?>
	<p>
		<a href="<?php echo $baseUrl ?><?php echo $row['sequence'] ?>.<?php echo $row['country_iso'] ?>.proftpd.org"><?php echo $baseUrl ?><?php echo $row['sequence'] ?>.<?php echo $row['country_iso'] ?>.proftpd.org/</a>
        <br />
		<a href="<?php echo $row['site'] ?>"><?php echo $row['site'] ?></a>
		<br />

		Location: <?php echo htmlentities($row['country']) ?>
		<?php if (!empty($row['city'])): ?>
			(<?php echo htmlentities($row['city']) ?>)
		<?php endif; ?>
		<br />

		<?php if (!empty($row['admin'])): ?>
			Maintained by: <?php echo htmlentities($row['admin']) ?><br />
		<?php endif; ?>
	</p>
<?php endwhile; ?>

#include "footer.epl"
